<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Powered Job Document Generator - Jobletters.xyz</title>
    
    <meta name="description" content="Generate professional, customized job documents (R√©sum√©s, Cover Letters, Resignation, Academic) instantly using advanced AI technology.">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0047ab">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
      // NEW FIRESTORE IMPORTS
      import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"; 
      
      const firebaseConfig = {
        apiKey: "AIzaSyDLGrQQd2SEppdZooI7VWV7I7h4l_QAdZs",
        authDomain: "jobletters-3c5ea.firebaseapp.com",
        projectId: "jobletters-3c5ea",
        storageBucket: "jobletters-3c5ea.firebasestorage.app",
        messagingSenderId: "473489426093",
        appId: "1:473489426093:web:fae4d21f759d14837aa824",
        measurementId: "G-TR8CQ7EP54"
      };
      
      // Initialize Firebase and make Firestore available globally
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      window.db = getFirestore(app); 
      
      // Expose the Firestore functions globally so the <script> block can use them
      window.firebase = { doc, getDoc, setDoc, updateDoc, collection, serverTimestamp, increment };
    </script>

    <style>
        /* All CSS from previous version remains here. 
           The crucial @media print block is included: */
        /* --- PRINT FIX: Hide everything except the document preview --- */
        @media print {
            body > *:not(.container), header, footer, .preview-actions, #preview-section h2 {
                display: none !important;
            }
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            #preview-section {
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                background: white !important;
            }
            #letter {
                max-height: none !important;
                overflow: visible !important;
                border: none !important;
                padding: 0 !important;
                /* Re-enable selection for printing */
                -webkit-user-select: text !important;
                -moz-user-select: text !important;
                -ms-user-select: text !important;
                user-select: text !important;
                font-family: 'Times New Roman', serif; /* Use a print-friendly font */
                font-size: 12pt;
                white-space: pre-wrap;
            }
        }
        /* ... rest of the CSS ... */
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Global variables and constants
        const STORAGE_PREFIX = 'jobletters_';
        const FLUTTERWAVE_PAY_LINK = "https://flutterwave.com/pay/uwoq2lwqfocj";
        const MOCK_ADMIN_API_KEY = "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";

        let currentDocumentType = "";
        let generatedDocumentText = "";
        let isPaid = false; 

        // --- PWA Service Worker Registration (Remains the same) ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js').then(registration => {
              console.log('SW registered: ', registration);
            }).catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
          });
        }

        // --- Menu Toggle Script (Remains the same) ---
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');
        hamburger.addEventListener('click', () => navMenu.classList.toggle('open'));

        // --- Load/Save Data Functions (UPDATED FOR FIRESTORE) ---
        function loadSavedData() {
            // Load local storage data for autofill
            if (document.getElementById('saveDataCheckbox')) {
                if (localStorage.getItem(STORAGE_PREFIX + 'saveDataCheckbox') === 'true') {
                    document.getElementById('saveDataCheckbox').checked = true;
                    document.getElementById('fullName').value = localStorage.getItem(STORAGE_PREFIX + 'fullName') || '';
                    document.getElementById('email').value = localStorage.getItem(STORAGE_PREFIX + 'email') || '';
                }
            }
        }
        
        /**
         * Saves contact data to localStorage (for autofill) and Firestore (for admin table).
         */
        async function saveData(data) {
            const contactData = {
                name: data.name,
                email: data.email,
                documentType: currentDocumentType,
                // Do NOT use lastGenerated here; use serverTimestamp for accuracy
            };

            // 1. Handle Contact Auto-fill Save (Local Storage)
            if (document.getElementById('saveDataCheckbox')?.checked) {
                localStorage.setItem(STORAGE_PREFIX + 'saveDataCheckbox', 'true');
                localStorage.setItem(STORAGE_PREFIX + 'fullName', contactData.name);
                localStorage.setItem(STORAGE_PREFIX + 'email', contactData.email);
            } else {
                localStorage.removeItem(STORAGE_PREFIX + 'saveDataCheckbox');
                localStorage.removeItem(STORAGE_PREFIX + 'fullName');
                localStorage.removeItem(STORAGE_PREFIX + 'email');
            }

            // 2. Save user for Admin Data Table (FIRESTORE)
            if (window.db && contactData.email) {
                const { doc, setDoc, serverTimestamp, increment } = window.firebase;
                const userRef = doc(window.db, "users", contactData.email);
                
                try {
                    await setDoc(userRef, {
                        name: contactData.name,
                        email: contactData.email,
                        lastGenerated: serverTimestamp(),
                        documentType: contactData.documentType,
                        generations: increment(1) 
                    }, { merge: true });
                    console.log("User data saved to Firestore:", contactData.email);
                } catch (error) {
                    console.error("Error saving user data to Firestore:", error);
                }
            }
        }

        // --- Price Synchronization Handler ---
        function updatePriceDisplay() {
            // Price is written to localStorage by initApp/admin page, so we read from here
            const price = localStorage.getItem(STORAGE_PREFIX + 'price') || '‚Ç¶500';
            const priceElement = document.getElementById('currentPrice');
            if (priceElement) {
                priceElement.textContent = price;
            }
        }
        
        // Listen for storage changes across tabs/windows (For Admin price sync)
        window.addEventListener('storage', (event) => {
            if (event.key === STORAGE_PREFIX + 'price') {
                updatePriceDisplay();
            }
        });


        /**
         * Initializes the app by fetching admin settings from Firestore.
         */
        async function initApp() {
            if (!window.db || !window.firebase) {
                // This means the module script failed to load (unlikely, but for safety)
                console.error("Firebase/Firestore not initialized. Using fallback data.");
                localStorage.setItem(STORAGE_PREFIX + 'api_key', MOCK_ADMIN_API_KEY);
                updatePriceDisplay();
                loadSavedData();
                return;
            }
            
            const { doc, getDoc, setDoc } = window.firebase;
            const configRef = doc(window.db, "settings", "config");
            let apiKey = MOCK_ADMIN_API_KEY;
            let price = '‚Ç¶500';
            
            try {
                const docSnap = await getDoc(configRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    apiKey = data.apiKey || MOCK_ADMIN_API_KEY;
                    price = data.documentPrice || '‚Ç¶500';
                } else {
                    // Initialize config if it doesn't exist (First Run)
                    await setDoc(configRef, { 
                        apiKey: MOCK_ADMIN_API_KEY, 
                        documentPrice: '‚Ç¶500',
                        totalIncome: 0,
                        totalGenerations: 0,
                        totalDownloads: 0,
                        lastUpdated: window.firebase.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Error fetching Firestore settings:", error);
            }

            // 2. Store settings in localStorage (for quick access and price sync)
            localStorage.setItem(STORAGE_PREFIX + 'api_key', apiKey);
            localStorage.setItem(STORAGE_PREFIX + 'price', price);
            
            // 3. Load UI and local data
            if (localStorage.getItem(STORAGE_PREFIX + 'admin_access') === 'granted') {
                document.getElementById('adminLink').classList.remove('hidden');
            }
            
            updatePriceDisplay();
            loadSavedData();
            document.getElementById('letter').oncontextmenu = () => false; 
        };

        // Run the initialization when the window loads
        window.addEventListener('load', () => {
             // Delay to ensure global variables are set by the module script
             setTimeout(initApp, 500); 
        });

        // --- Form Display Logic (Remains the same) ---
        function showForm(docType) {
          const forms = document.querySelectorAll('#formsContainer > div');
          forms.forEach(form => form.classList.add('hidden'));

          if (docType) {
              const formId = docType + 'Form';
              document.getElementById(formId).classList.remove('hidden');
              document.getElementById('generateBtn').classList.remove('hidden');
              document.getElementById('preview-section').classList.add('hidden');
          } else {
              document.getElementById('generateBtn').classList.add('hidden');
              document.getElementById('preview-section').classList.add('hidden');
          }
          currentDocumentType = docType;
          isPaid = false; 
          updateDownloadButtons(false);
        }

        // --- Academic Prompt Helper (Remains the same) ---
        function updateAcademicPrompt(purpose) {
            const label = document.getElementById('ac_details_label');
            if (purpose === 'course_change') {
                label.textContent = "Courses to Add/Drop and Justification *";
            } else if (purpose === 'result_statement') {
                label.textContent = "Specify Academic Session(s) and Reason for Request *";
            } else if (purpose === 'apology') {
                label.textContent = "Dates and Circumstances Requiring Apology *";
            } else {
                label.textContent = "Details / Justification *";
            }
        }

        // --- Core Generation Logic (UPDATED: Uses Firestore-enabled saveData) ---
        async function generateDocument() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = 'AI is Drafting... <span class="spinner"></span>';
            btn.classList.add('ai-generating');
            document.getElementById('preview-section').classList.add('hidden');

            if (!validateForm(currentDocumentType)) {
                showModal("‚ö†Ô∏è Please fill in all required fields (*).");
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI-Enhanced Document';
                btn.classList.remove('ai-generating');
                return;
            }

            const data = collectFormData(currentDocumentType);
            
            // Save Contact Data and increment generation count (NOW USES FIRESTORE)
            if (currentDocumentType === 'resume' || currentDocumentType === 'coverLetter') {
                 await saveData(data); 
            } else {
                // If it's a resignation/academic, only increment the global generation count
                if (window.db) {
                     const { doc, updateDoc, increment, serverTimestamp } = window.firebase;
                     const configRef = doc(window.db, "settings", "config");
                     try {
                          await updateDoc(configRef, {
                            totalGenerations: increment(1),
                            lastUpdated: serverTimestamp()
                          });
                     } catch (error) {
                          console.error("Error updating global generation count:", error);
                     }
                }
            }


            // --- SECURE MOCK API CALL CHECK ---
            const adminKey = localStorage.getItem(STORAGE_PREFIX + 'api_key');
            if (!adminKey || adminKey === '') {
                 showModal("üîë System error: AI Key not configured by Admin. Cannot generate document.");
                 btn.disabled = false;
                 btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI-Enhanced Document';
                 btn.classList.remove('ai-generating');
                 return;
            }
            
            // Mock a successful API call delay
            await new Promise(resolve => setTimeout(resolve, 2000)); 
            const mockGeneratedText = mockAIGenerator(currentDocumentType, data);
            
            // Display Results
            generatedDocumentText = mockGeneratedText;
            document.getElementById('letter').textContent = generatedDocumentText;
            
            document.getElementById('preview-section').classList.remove('hidden');
            document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });
            
            // Reset payment status and buttons
            isPaid = false;
            updateDownloadButtons(false);

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI-Enhanced Document';
            btn.classList.remove('ai-generating');
            showModal("‚úÖ AI Draft complete! Review and Download.");
        }
        
        function regenerateDocument() {
            generateDocument();
            showModal("üîÑ Regenerating document...");
        }

        // --- Download Button Control Function (Remains the same) ---
        function updateDownloadButtons(paidStatus) {
            isPaid = paidStatus;
            const payBtn = document.getElementById('payBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const emailBtn = document.getElementById('emailBtn');
            const printBtn = document.getElementById('printBtn');

            if (paidStatus) {
                // If paid, enable final actions
                payBtn.style.display = 'none';
                downloadBtn.style.display = 'block';
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('disabled-action');
                emailBtn.disabled = false;
                emailBtn.classList.remove('disabled-action');
                printBtn.disabled = false;
                printBtn.classList.remove('disabled-action');
            } else {
                // If not paid, hide download and show pay button (and disable others)
                payBtn.style.display = 'block';
                downloadBtn.style.display = 'none';
                downloadBtn.disabled = true;
                downloadBtn.classList.add('disabled-action');
                emailBtn.disabled = true;
                emailBtn.classList.add('disabled-action');
                printBtn.disabled = true;
                printBtn.classList.add('disabled-action');
            }
        }
        
        // --- Payment Handler (UPDATED: Mock income saved to Firestore) ---
        async function handlePayment() {
            showModal("üí≥ Redirecting to Flutterwave for secure payment...");
            
            // Open payment link in a new tab
            window.open(FLUTTERWAVE_PAY_LINK, '_blank');
            
            // Mock a successful return from payment after a delay
            setTimeout(async () => {
                showModal("‚úÖ Payment simulated successfully! Document unlocked.");
                
                // Update Metrics in Firestore (NEW)
                const priceText = document.getElementById('currentPrice').textContent.replace('‚Ç¶', '');
                const numericPrice = parseInt(priceText.replace(/[^\d]/g, '') || '500'); 
                
                if (window.db) {
                    const { doc, updateDoc, increment, serverTimestamp } = window.firebase;
                    const configRef = doc(window.db, "settings", "config");
                    try {
                        await updateDoc(configRef, {
                            totalIncome: increment(numericPrice),
                            totalDownloads: increment(1),
                            lastUpdated: serverTimestamp()
                        });
                    } catch (error) {
                         console.error("Error updating metrics in Firestore:", error);
                    }
                }

                // Enable all final action buttons
                updateDownloadButtons(true);

            }, 5000); 
        }
        
        // --- Core Generator Functions (Unchanged) ---
        function collectFormData(docType) {
            // ... (remains the same as previous version) ...
            if (docType === 'resume') {
                return {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    experience: document.getElementById('experience').value,
                    education: document.getElementById('education').value,
                    skills: document.getElementById('skills').value,
                };
            }
            if (docType === 'coverLetter') {
                return {
                    name: document.getElementById('cl_fullName').value,
                    email: document.getElementById('email') ? document.getElementById('email').value : '', // Try to use the primary email field if available
                    jobTitle: document.getElementById('cl_jobTitle').value,
                    companyName: document.getElementById('cl_companyName').value,
                    experience: document.getElementById('cl_experience').value,
                };
            }
            if (docType === 'resignation') {
                return {
                    name: document.getElementById('rl_fullName').value,
                    position: document.getElementById('rl_position').value,
                    lastDay: document.getElementById('rl_lastDay').value,
                    reason: document.getElementById('rl_reason').value,
                };
            }
            if (docType === 'academic') {
                return {
                    name: document.getElementById('ac_fullName').value,
                    matricNumber: document.getElementById('ac_matricNumber').value,
                    recipient: document.getElementById('ac_recipient').value,
                    purpose: document.getElementById('ac_purpose').value,
                    details: document.getElementById('ac_details').value,
                };
            }
            return {};
        }

        function mockAIGenerator(docType, data) {
            // ... (remains the same as previous version) ...
            if (docType === "resume") {
                return `PROFESSIONAL R√âSUM√â - AI GENERATED 
${'='.repeat(60)}
${data.name.toUpperCase()}
${data.email} | (Details Hidden)
${'='.repeat(60)}

SUMMARY
A highly accomplished professional with experience in:
${data.experience.split('\n').map(line => `‚Ä¢ ${line.trim()}`).join('\n')}

EDUCATION
${data.education}

KEY SKILLS
${data.skills}
---
AI Note: This is a powerful, concise draft designed for maximum impact.`;
            } else if (docType === "academic") {
                 const currentDate = new Date().toLocaleDateString('en-GB');
                 const purposeTitle = data.purpose.replace(/_/g, ' ').toUpperCase();
                 const recipientTitle = data.recipient === 'HOD' ? 'The Head of Department' : data.recipient === 'Dean' ? 'The Dean of Faculty' : data.recipient === 'Registrar' ? 'The University Registrar' : 'A Specific Lecturer';
                 const salutation = data.recipient === 'Lecturer' ? 'Dear Sir/Madam,' : `Dear ${data.recipient},`;

                 return `${currentDate}

${recipientTitle}
[Department/Faculty Name]
[University Name]

${salutation}

SUBJECT: FORMAL REQUEST FOR ${purposeTitle} - ${data.matricNumber}

I am writing to formally request the ${data.purpose.replace(/_/g, ' ')} concerning my academic records/status.

My details are:
Name: ${data.name}
Matriculation Number: ${data.matricNumber}

JUSTIFICATION / DETAILS
${data.details}

I sincerely apologize for any inconvenience this may cause and kindly request your favorable consideration and prompt action on this matter.

Thank you.

Yours faithfully,
${data.name}
${data.matricNumber}`;
            } else if (docType === "coverLetter") {
                 return `[Date]

[Hiring Manager Name]
[Company Name]
[Company Address]

Dear [Hiring Manager],

I am writing to express my enthusiastic interest in the ${data.jobTitle} position at ${data.companyName}. With a background in ${data.experience.split('\n')[0].substring(0, 50)}..., I possess the necessary skills to excel.

I look forward to discussing how my experience can benefit your team.

Sincerely,
${data.name}`;
            } else if (docType === "resignation") {
                 return `[Date]

[Manager Name]
[Company Name]

Dear [Manager Name],

Please accept this letter as formal notification that I am resigning from my position as ${data.position}, effective ${data.lastDay}. My reason for leaving is ${data.reason}.

Thank you for the opportunity to work here.

Sincerely,
${data.name}`;
            }
            return "AI could not generate document. Please provide more detailed input.";
        }
        
        // --- Utility Functions (Remains the same) ---
        function validateForm(docType) { 
          if (docType === "resume") {
                return document.getElementById('fullName').value && document.getElementById('email').value && document.getElementById('experience').value && document.getElementById('education').value && document.getElementById('skills').value;
            } else if (docType === "coverLetter") {
                 return document.getElementById('cl_fullName').value && document.getElementById('cl_jobTitle').value && document.getElementById('cl_companyName').value && document.getElementById('cl_experience').value;
            } else if (docType === "resignation") {
                 return document.getElementById('rl_fullName').value && document.getElementById('rl_position').value && document.getElementById('rl_lastDay').value;
            } else if (docType === "academic") {
                 return document.getElementById('ac_fullName').value && document.getElementById('ac_matricNumber').value && document.getElementById('ac_purpose').value && document.getElementById('ac_details').value;
            }
          return true; 
        }

        // Mock PDF Download (Only works if paid)
        function downloadPDF() { 
            if (!isPaid) {
                 showModal("‚ùå Please complete payment to download the final document.");
                 return;
            }
            showModal("üìÑ Generating PDF...");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const docTypeDisplay = document.getElementById('documentType').options[document.getElementById('documentType').selectedIndex].text;
            const filename = `${docTypeDisplay.replace(/[^a-zA-Z0-9]/g, '_')}_Generated.pdf`;

            doc.setFontSize(12);
            const lines = doc.splitTextToSize(generatedDocumentText, 180);
            doc.text(lines, 10, 10);
            doc.save(filename);

            showModal("‚úÖ PDF downloaded successfully!");
        }

        // Print Document (FIXED: Only works if paid & CSS media query handles print area)
        function printDocument() { 
            if (!isPaid) {
                 showModal("‚ùå Please complete payment to print the final document.");
                 return;
            }
            window.print(); 
        }

        // Email Document (FIXED: Only works if paid & uses mailto:)
        function emailDocument() { 
            if (!isPaid) {
                 showModal("‚ùå Please complete payment to email the final document.");
                 return;
            }
            
            const emailData = collectFormData(currentDocumentType);
            const subject = `Your ${document.getElementById('documentType').options[document.getElementById('documentType').selectedIndex].text} from Jobletters.xyz`;
            const body = `Dear ${emailData.name || 'User'},\n\nAttached is your final AI-generated document:\n\n---\n${generatedDocumentText}\n---`;
            
            window.location.href = `mailto:${emailData.email || 'recipient@example.com'}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            showModal("üìß Opening your email client..."); 
        }

        function showModal(message) {
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.textContent = message;
          document.body.appendChild(modal);
          modal.offsetWidth; 
          modal.classList.add('show');
          setTimeout(() => {
              modal.classList.remove('show');
              setTimeout(() => modal.remove(), 500);
          }, 4000);
        }
        
        // Admin access cheat code
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && (e.ctrlKey || e.metaKey) && e.key === 'A') {
                e.preventDefault();
                const password = prompt("Admin Secret Code:");
                if (password === 'jobadmin2025') { 
                    localStorage.setItem(STORAGE_PREFIX + 'admin_access', 'granted');
                    document.getElementById('adminLink').classList.remove('hidden');
                    showModal("üîë Admin access granted! Link is in the top menu.");
                } else if (password !== null) {
                    showModal("‚ùå Invalid Secret Code.");
                }
            }
        });
    </script>
</body>
</html>
