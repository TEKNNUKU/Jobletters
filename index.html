<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Powered Job Document Generator - Jobletters.xyz</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0047ab">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
      // Import ALL necessary Firestore functions
      import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        updateDoc, 
        collection, 
        serverTimestamp, 
        increment 
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"; 
      
      // NOTE: This config is public and not a security risk. The AI Key is fetched separately.
      const firebaseConfig = {
        apiKey: "AIzaSyDLGrQQd2SEppdZooI7VWV7I7h4l_QAdZs",
        authDomain: "jobletters-3c5ea.firebaseapp.com",
        projectId: "jobletters-3c5ea",
        storageBucket: "jobletters-3c5ea.firebasestorage.app",
        messagingSenderId: "473489426093",
        appId: "1:473489426093:web:fae4d21f759d14837aa824",
        measurementId: "G-TR8CQ7EP54"
      };
      
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      window.db = getFirestore(app); 
      
      // Expose the Firestore functions globally 
      window.firebase = { 
          doc, getDoc, setDoc, updateDoc, collection, 
          serverTimestamp, increment 
      };
    </script>

    <style>
        /* Base CSS Styles (omitted for brevity) */
        
        /* --- PRINT FIX: Hide everything except the document preview --- */
        @media print {
            /* Hide the whole page except the main content */
            body > *:not(main), header, footer, .preview-actions, #preview-section h2 {
                display: none !important;
            }
            /* Make the container full width and remove shadows */
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                background: white !important;
            }
            #preview-section {
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                background: white !important;
            }
            #letter {
                max-height: none !important;
                overflow: visible !important;
                border: none !important;
                padding: 1in !important; /* Add standard print margins */
                -webkit-user-select: text !important;
                user-select: text !important;
                font-family: 'Times New Roman', serif; 
                font-size: 12pt;
                white-space: pre-wrap;
            }
        }
        
        /* ... (rest of the base styles remain the same) ... */
        :root { --primary: #0047ab; --secondary: #667eea; --accent: #ffd700; --bg-color: #f7f9fc; --text-color: #333; --card-bg: white; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        * { box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
        header { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; }
        .logo i { margin-right: 10px; color: var(--accent); }
        .logo span { background-color: var(--accent); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 14px; font-weight: 700; margin-left: 10px; }
        .hamburger { font-size: 24px; cursor: pointer; display: block; }
        nav { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: #003380; padding-top: 60px; transition: right 0.3s ease-in-out; z-index: 999; box-shadow: -5px 0 15px rgba(0,0,0,0.3); }
        nav.open { right: 0; }
        nav a { color: white; padding: 15px 20px; text-decoration: none; display: block; border-bottom: 1px solid #0047ab; transition: background-color 0.2s; }
        nav a:hover { background-color: var(--primary); }
        .container { max-width: 800px; margin: 30px auto; padding: 20px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-top: 0; font-size: 28px; }
        h2 i { color: var(--accent); margin-right: 10px; }
        form label { display: block; font-weight: 600; margin-top: 15px; }
        form input, form select, form textarea { font-family: 'Montserrat', sans-serif; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; padding: 12px; margin-top: 5px; width: 100%; resize: vertical; }
        .document-select-container { background: #e6f0ff; border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .document-select-container label { color: var(--primary); font-size: 18px; font-weight: 700; }
        .btn-primary { background: var(--primary); color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; margin-top: 20px; width: 100%; }
        .btn-primary:hover:not(:disabled) { background: #003380; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .ai-generating { background: var(--secondary) !important; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.8; } }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Preview Section Styles */
        #preview-section { margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        #preview-section h2 { font-size: 24px; color: var(--success); }
        #letter { min-height: 400px; padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9; white-space: pre-wrap; font-family: monospace; overflow-y: auto; max-height: 450px; user-select: none; /* Prevent selection before payment */ }
        
        /* Action Buttons */
        .preview-actions { margin-top: 20px; text-align: center; }
        .preview-actions button { display: block; width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; }
        #regenerateBtn { background: var(--primary); color: white; }
        #payBtn { background: var(--accent); color: var(--primary); }
        #downloadBtn { background: var(--success); color: white; display: none; }
        .preview-actions button.disabled-action { background: #ccc; color: #666; cursor: not-allowed; }
        .small-action-btns { display: flex; justify-content: space-around; margin-top: 15px; }
        .small-action-btns button { background: none; color: var(--primary); border: 1px solid #eee; padding: 10px 15px; width: 48%; }
        
        /* Modal */
        .modal { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 100%); background: var(--primary); color: white; padding: 15px 25px; border-radius: 8px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.5s ease-out, opacity 0.5s; opacity: 0; }
        .modal.show { transform: translate(-50%, 0); opacity: 1; }
        
        /* Footer */
        footer { text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #eee; font-size: 14px; color: #777; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><i class="fas fa-envelope"></i> Jobletters.xyz <span>AI POWERED</span></div>
        <div id="hamburger" class="hamburger">&#9776;</div>
        <nav id="navMenu">
            <a href="index.html">Generate Document</a>
            <a href="pricing.html">Pricing (Mock)</a>
            <a href="how-it-works.html">How It Works</a>
            <a href="contact.html">Contact Support</a>
            <a href="admin.html" id="adminLink" class="hidden"><i class="fas fa-lock"></i> Admin Panel</a>
        </nav>
    </header>

    <main class="container">
        <h2>🤖 AI-Powered Job Document Generator</h2>
        <p style="text-align: center; color: #555;">Create perfectly tailored professional documents using advanced AI. Just provide your details and let AI craft the perfect document for you.</p>

        <div class="document-select-container">
            <label for="documentType">Select Document Type</label>
            <select id="documentType" onchange="showForm(this.value)">
                <option value="">-- Select Document Type --</option>
                <option value="resume">Professional Résumé / CV</option>
                <option value="coverLetter">Cover Letter</option>
                <option value="resignation">Resignation Letter</option>
                <option value="academic">Academic Letter / Statement</option>
            </select>
        </div>

        <div id="formsContainer">
            <div id="resumeForm" class="hidden">
                <label for="fullName">Full Name *</label>
                <input type="text" id="fullName" placeholder="Precious Naza Raymond Nwachukwu" required />
                
                <label for="email">Email Address *</label>
                <input type="email" id="email" placeholder="name@example.com" required />
                
                <label>
                    <input type="checkbox" id="saveDataCheckbox"> Save my name and email for next time.
                </label>

                <label for="experience">Work Experience Summary * (2-3 Key Achievements/Roles)</label>
                <textarea id="experience" rows="4" placeholder="Managed a team of 5, boosting sales by 20% in Q4. Developed and launched a new CRM system."></textarea>
                
                <label for="education">Education / Certifications * (Degree, School, Year)</label>
                <textarea id="education" rows="3" placeholder="B.Sc. Computer Science, University of Lagos (2018). Certified Scrum Master."></textarea>

                <label for="skills">Key Skills * (Comma Separated)</label>
                <input type="text" id="skills" placeholder="Python, SQL, Project Management, Leadership" />
            </div>

            <div id="coverLetterForm" class="hidden">
                <label for="cl_fullName">Your Full Name *</label>
                <input type="text" id="cl_fullName" required />
                
                <label for="cl_jobTitle">Target Job Title *</label>
                <input type="text" id="cl_jobTitle" placeholder="Senior Software Engineer" required />
                
                <label for="cl_companyName">Company Name *</label>
                <input type="text" id="cl_companyName" required />
                
                <label for="cl_experience">Specific Relevant Experience * (2-3 bullet points)</label>
                <textarea id="cl_experience" rows="5" placeholder="Led a 6-month migration project to AWS cloud, cutting hosting costs by 15%."></textarea>
            </div>

            <div id="resignationForm" class="hidden">
                <label for="rl_fullName">Your Full Name *</label>
                <input type="text" id="rl_fullName" required />
                
                <label for="rl_position">Your Position *</label>
                <input type="text" id="rl_position" required />
                
                <label for="rl_lastDay">Last Day of Employment *</label>
                <input type="date" id="rl_lastDay" required />

                <label for="rl_reason">Reason for Resignation (Optional, but recommended)</label>
                <textarea id="rl_reason" rows="3" placeholder="Pursuing a new opportunity for professional growth."></textarea>
            </div>

            <div id="academicForm" class="hidden">
                <label for="ac_fullName">Your Full Name *</label>
                <input type="text" id="ac_fullName" required />
                
                <label for="ac_matricNumber">Matriculation / Student Number *</label>
                <input type="text" id="ac_matricNumber" required />

                <label for="ac_recipient">Recipient *</label>
                <select id="ac_recipient" required>
                    <option value="">-- Select Recipient --</option>
                    <option value="HOD">Head of Department (HOD)</option>
                    <option value="Dean">Dean of Faculty</option>
                    <option value="Registrar">University Registrar</option>
                    <option value="Lecturer">Specific Lecturer</option>
                </select>
                
                <label for="ac_purpose">Purpose of Letter *</label>
                <select id="ac_purpose" onchange="updateAcademicPrompt(this.value)" required>
                    <option value="">-- Select Purpose --</option>
                    <option value="course_change">Course Add/Drop Request</option>
                    <option value="result_statement">Request for Statement of Result</option>
                    <option value="apology">Formal Apology</option>
                    <option value="other">Other Formal Request</option>
                </select>

                <label for="ac_details" id="ac_details_label">Details / Justification *</label>
                <textarea id="ac_details" rows="5" placeholder="State the details, dates, and justification for your request."></textarea>
            </div>
        </div>

        <button id="generateBtn" class="btn-primary hidden" onclick="generateDocument()">
            <i class="fas fa-magic"></i> Generate AI-Enhanced Document
        </button>

        <div id="preview-section" class="hidden">
            <h2 id="preview-title"><i class="fas fa-file-alt"></i> Document Preview (AI Draft)</h2>
            <div id="letter" contenteditable="true" spellcheck="false">
                </div>

            <div class="preview-actions">
                <button id="regenerateBtn" onclick="regenerateDocument()">
                    <i class="fas fa-sync-alt"></i> Regenerate
                </button>

                <button id="payBtn" onclick="handlePayment()">
                    💳 Pay <span id="currentPrice">₦500</span> & Download
                </button>

                <button id="downloadBtn" onclick="downloadPDF()">
                    <i class="fas fa-download"></i> Download PDF
                </button>

                <div class="small-action-btns">
                    <button id="emailBtn" onclick="emailDocument()" class="disabled-action" disabled>
                        <i class="fas fa-envelope"></i> Email Document
                    </button>
                    <button id="printBtn" onclick="printDocument()" class="disabled-action" disabled>
                        <i class="fas fa-print"></i> Print Draft
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        &copy; 2025 Jobletters.xyz. All rights reserved. <br> Powered by AI Technology
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Global variables and constants
        const STORAGE_PREFIX = 'jobletters_';
        const FLUTTERWAVE_PAY_LINK = "https://flutterwave.com/pay/uwoq2lwqfocj";
        
        // CRITICAL SECURITY FIX: This key is now blank and MUST come from Firestore.
        const MOCK_ADMIN_API_KEY = ""; 
        
        let currentDocumentType = "";
        let generatedDocumentText = "";
        // NEW: This flag MUST be managed carefully
        let isPaid = false; 
        let paymentWindow = null; // Track the payment pop-up window

        // --- PWA Service Worker Registration (Remains the same) ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js').then(registration => {
              console.log('SW registered: ', registration);
            }).catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
          });
        }

        // --- Menu Toggle Script (Remains the same) ---
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');
        hamburger.addEventListener('click', () => navMenu.classList.toggle('open'));

        // --- Load/Save Data Functions (Remains the same) ---
        function loadSavedData() {
            // Load local storage data for autofill
            if (document.getElementById('saveDataCheckbox')) {
                if (localStorage.getItem(STORAGE_PREFIX + 'saveDataCheckbox') === 'true') {
                    document.getElementById('saveDataCheckbox').checked = true;
                    document.getElementById('fullName').value = localStorage.getItem(STORAGE_PREFIX + 'fullName') || '';
                    document.getElementById('email').value = localStorage.getItem(STORAGE_PREFIX + 'email') || '';
                }
            }
        }
        
        async function saveData(data) {
            const contactData = {
                name: data.name,
                email: data.email,
                documentType: currentDocumentType,
            };

            // 1. Handle Contact Auto-fill Save (Local Storage)
            if (document.getElementById('saveDataCheckbox')?.checked) {
                localStorage.setItem(STORAGE_PREFIX + 'saveDataCheckbox', 'true');
                localStorage.setItem(STORAGE_PREFIX + 'fullName', contactData.name);
                localStorage.setItem(STORAGE_PREFIX + 'email', contactData.email);
            } else {
                localStorage.removeItem(STORAGE_PREFIX + 'saveDataCheckbox');
                localStorage.removeItem(STORAGE_PREFIX + 'fullName');
                localStorage.removeItem(STORAGE_PREFIX + 'email');
            }

            // 2. Save user for Admin Data Table (FIRESTORE)
            if (window.db && contactData.email) {
                const { doc, setDoc, serverTimestamp, increment } = window.firebase;
                const userRef = doc(window.db, "users", contactData.email);
                
                try {
                    await setDoc(userRef, {
                        name: contactData.name,
                        email: contactData.email,
                        lastGenerated: serverTimestamp(),
                        documentType: contactData.documentType,
                        generations: increment(1) 
                    }, { merge: true });
                } catch (error) {
                    console.error("Error saving user data to Firestore:", error);
                }
            }
        }

        // --- Price Synchronization Handler (Remains the same) ---
        function updatePriceDisplay() {
            const price = localStorage.getItem(STORAGE_PREFIX + 'price') || '₦500';
            document.getElementById('currentPrice').textContent = price;
        }
        
        window.addEventListener('storage', (event) => {
            if (event.key === STORAGE_PREFIX + 'price') {
                updatePriceDisplay();
            }
        });


        /**
         * Initializes the app by fetching admin settings from Firestore.
         */
        async function initApp() {
            if (!window.db || !window.firebase) {
                console.error("Firebase/Firestore not initialized. Cannot fetch settings.");
                localStorage.setItem(STORAGE_PREFIX + 'api_key', MOCK_ADMIN_API_KEY);
                updatePriceDisplay();
                loadSavedData();
                return;
            }
            
            const { doc, getDoc, setDoc, serverTimestamp } = window.firebase;
            const configRef = doc(window.db, "settings", "config");
            let apiKey = MOCK_ADMIN_API_KEY;
            let price = '₦500';
            
            try {
                const docSnap = await getDoc(configRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    apiKey = data.apiKey || MOCK_ADMIN_API_KEY;
                    price = data.documentPrice || '₦500';
                } else {
                    // Initialize config if it doesn't exist (First Run)
                    await setDoc(configRef, { 
                        apiKey: MOCK_ADMIN_API_KEY, 
                        documentPrice: '₦500',
                        totalIncome: 0,
                        totalGenerations: 0,
                        totalDownloads: 0,
                        lastUpdated: serverTimestamp()
                    });
                }
            } catch (error) {
                // This is where your "permission-denied" error is logged
                console.warn("Network/Firestore error fetching settings. Using fallback key/price.", error);
                showModal("❌ ERROR: Cannot connect to settings. Check security rules.", true);
            }

            // Store settings in localStorage
            localStorage.setItem(STORAGE_PREFIX + 'api_key', apiKey);
            localStorage.setItem(STORAGE_PREFIX + 'price', price);
            
            // Load UI and local data
            if (localStorage.getItem(STORAGE_PREFIX + 'admin_access') === 'granted') {
                document.getElementById('adminLink').classList.remove('hidden');
            }
            
            updatePriceDisplay();
            loadSavedData();
            document.getElementById('letter').oncontextmenu = () => false; 
            // NEW: Start the payment check interval only after init
            setInterval(checkPaymentStatus, 1000); 
        };

        window.addEventListener('load', () => {
             // Delay to ensure module script runs first
             setTimeout(initApp, 500); 
        });

        // --- Form Display Logic (Remains the same) ---
        function showForm(docType) {
          const forms = document.querySelectorAll('#formsContainer > div');
          forms.forEach(form => form.classList.add('hidden'));

          if (docType) {
              const formId = docType + 'Form';
              document.getElementById(formId).classList.remove('hidden');
              document.getElementById('generateBtn').classList.remove('hidden');
              document.getElementById('preview-section').classList.add('hidden');
          } else {
              document.getElementById('generateBtn').classList.add('hidden');
              document.getElementById('preview-section').classList.add('hidden');
          }
          currentDocumentType = docType;
          isPaid = false; 
          updateDownloadButtons(false);
        }

        function updateAcademicPrompt(purpose) {
            const label = document.getElementById('ac_details_label');
            if (purpose === 'course_change') {
                label.textContent = "Courses to Add/Drop and Justification *";
            } else if (purpose === 'result_statement') {
                label.textContent = "Specify Academic Session(s) and Reason for Request *";
            } else if (purpose === 'apology') {
                label.textContent = "Dates and Circumstances Requiring Apology *";
            } else {
                label.textContent = "Details / Justification *";
            }
        }

        // --- Core Generation Logic (Remains the same) ---
        async function generateDocument() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = 'AI is Drafting... <span class="spinner"></span>';
            btn.classList.add('ai-generating');
            document.getElementById('preview-section').classList.add('hidden');

            if (!validateForm(currentDocumentType)) {
                showModal("⚠️ Please fill in all required fields (*).", true);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI-Enhanced Document';
                btn.classList.remove('ai-generating');
                return;
            }

            const data = collectFormData(currentDocumentType);
            const adminKey = localStorage.getItem(STORAGE_PREFIX + 'api_key');
            
            if (!adminKey || adminKey === '') {
                 showModal("🔑 System error: AI Key not configured by Admin. Cannot generate document.", true);
                 btn.disabled = false;
                 btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI-Enhanced Document';
                 btn.classList.remove('ai-generating');
                 return;
            }
            
            if (currentDocumentType === 'resume' || currentDocumentType === 'coverLetter') {
                 await saveData(data); 
            } else {
                if (window.db) {
                     const { doc, updateDoc, increment, serverTimestamp } = window.firebase;
                     const configRef = doc(window.db, "settings", "config");
                     try {
                          await updateDoc(configRef, { totalGenerations: increment(1), lastUpdated: serverTimestamp() });
                     } catch (error) {
                          console.error("Error updating global generation count:", error);
                     }
                }
            }
            
            // Mock a successful API call delay
            await new Promise(resolve => setTimeout(resolve, 2000)); 
            const mockGeneratedText = mockAIGenerator(currentDocumentType, data);
            
            // Display Results
            generatedDocumentText = mockGeneratedText;
            document.getElementById('letter').textContent = generatedDocumentText;
            
            document.getElementById('preview-section').classList.remove('hidden');
            document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });
            
            // Reset payment status and buttons
            isPaid = false;
            updateDownloadButtons(false);

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI-Enhanced Document';
            btn.classList.remove('ai-generating');
            showModal("✅ AI Draft complete! Review and Download.");
        }
        
        function regenerateDocument() {
            generateDocument();
            showModal("🔄 Regenerating document...");
        }

        // --- Download Button Control Function (Remains the same) ---
        function updateDownloadButtons(paidStatus) {
            isPaid = paidStatus;
            const payBtn = document.getElementById('payBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const emailBtn = document.getElementById('emailBtn');
            const printBtn = document.getElementById('printBtn');

            if (paidStatus) {
                payBtn.style.display = 'none';
                downloadBtn.style.display = 'block';
                emailBtn.disabled = false;
                emailBtn.classList.remove('disabled-action');
                printBtn.disabled = false;
                printBtn.classList.remove('disabled-action');
                document.getElementById('letter').style.userSelect = 'text'; // Enable selection
            } else {
                payBtn.style.display = 'block';
                downloadBtn.style.display = 'none';
                emailBtn.disabled = true;
                emailBtn.classList.add('disabled-action');
                printBtn.disabled = true;
                printBtn.classList.add('disabled-action');
                document.getElementById('letter').style.userSelect = 'none'; // Disable selection
            }
        }
        
        // --- Payment Handler (FIXED LOGIC) ---
        async function handlePayment() {
            showModal("💳 Redirecting to Flutterwave for secure payment...");
            
            // Open payment link in a new tab/window
            // Use window.open to track if the window is closed
            paymentWindow = window.open(FLUTTERWAVE_PAY_LINK, '_blank', 'width=600,height=600');
            
            // We do NOT simulate success immediately here. The interval checker takes over.
            // The user must return from the payment page for it to succeed.

            // The Flutterwave link should eventually redirect back to a success page 
            // that signals the app (e.g., by setting a flag in localStorage or a database).
            // For this mock, we rely on the interval check below.
        }

        /**
         * FIX: Checks if the mock payment window is closed. 
         * In a real app, this would check a database status.
         */
        async function checkPaymentStatus() {
            // Check if payment simulation has already succeeded
            if (isPaid) return; 

            // Check if the payment window was opened and has been closed by the user
            if (paymentWindow && paymentWindow.closed) {
                // The payment window was opened and then closed by the user.
                // In a real app, if the backend didn't confirm payment, we assume failure.
                paymentWindow = null; // Clear the reference
                showModal("❌ Payment window closed. Please complete payment to download.", true);
                updateDownloadButtons(false);
            } 
            
            // --- MOCK SUCCESS PATH ---
            // Because we don't have a real payment gateway callback, we'll use a timer 
            // and assume success if the user keeps the window open for 10 seconds.
            // THIS IS STILL MOCK LOGIC! The proper fix is a backend check.
            if (paymentWindow && !paymentWindow.closed) {
                 // For the mock, we'll force success after a short wait (5 seconds)
                 if (paymentWindow.startTime === undefined) {
                      paymentWindow.startTime = Date.now();
                 }
                 
                 if (Date.now() - paymentWindow.startTime >= 5000) {
                     // Payment is "confirmed" by mock logic
                     paymentWindow.close(); // Close the mock window after confirmation
                     paymentWindow = null; 
                     
                     showModal("✅ Payment simulated successfully! Document unlocked.");
                     
                     // Update Metrics in Firestore
                     const priceText = document.getElementById('currentPrice').textContent.replace('₦', '');
                     const numericPrice = parseInt(priceText.replace(/[^\d]/g, '') || '500'); 
                     
                     if (window.db) {
                         const { doc, updateDoc, increment, serverTimestamp } = window.firebase;
                         const configRef = doc(window.db, "settings", "config");
                         try {
                             await updateDoc(configRef, {
                                 totalIncome: increment(numericPrice),
                                 totalDownloads: increment(1),
                                 lastUpdated: serverTimestamp()
                             });
                         } catch (error) {
                             console.error("Error updating metrics in Firestore:", error);
                         }
                     }
                     
                     updateDownloadButtons(true);
                 }
            }
        }

        // --- Core Generator Functions (Unchanged) ---
        function collectFormData(docType) {
            // ... (remains the same) ...
             if (docType === 'resume') {
                return {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    experience: document.getElementById('experience').value,
                    education: document.getElementById('education').value,
                    skills: document.getElementById('skills').value,
                };
            }
            if (docType === 'coverLetter') {
                return {
                    name: document.getElementById('cl_fullName').value,
                    // Use resume form's email if available, otherwise blank
                    email: document.getElementById('email') ? document.getElementById('email').value : '', 
                    jobTitle: document.getElementById('cl_jobTitle').value,
                    companyName: document.getElementById('cl_companyName').value,
                    experience: document.getElementById('cl_experience').value,
                };
            }
            if (docType === 'resignation') {
                return {
                    name: document.getElementById('rl_fullName').value,
                    email: document.getElementById('email') ? document.getElementById('email').value : '',
                    position: document.getElementById('rl_position').value,
                    lastDay: document.getElementById('rl_lastDay').value,
                    reason: document.getElementById('rl_reason').value,
                };
            }
            if (docType === 'academic') {
                return {
                    name: document.getElementById('ac_fullName').value,
                    email: document.getElementById('email') ? document.getElementById('email').value : '',
                    matricNumber: document.getElementById('ac_matricNumber').value,
                    recipient: document.getElementById('ac_recipient').value,
                    purpose: document.getElementById('ac_purpose').value,
                    details: document.getElementById('ac_details').value,
                };
            }
            return {};
        }

        function mockAIGenerator(docType, data) {
            // ... (remains the same) ...
             if (docType === "resume") {
                return `PROFESSIONAL RÉSUMÉ - AI GENERATED 
${'='.repeat(60)}
${data.name.toUpperCase()}
${data.email} | (Details Hidden)
${'='.repeat(60)}

SUMMARY
A highly accomplished professional with experience in:
${data.experience.split('\n').map(line => `• ${line.trim()}`).join('\n')}

EDUCATION
${data.education}

KEY SKILLS
${data.skills}
---
AI Note: This is a powerful, concise draft designed for maximum impact.`;
            } else if (docType === "academic") {
                 const currentDate = new Date().toLocaleDateString('en-GB');
                 const purposeTitle = data.purpose.replace(/_/g, ' ').toUpperCase();
                 const recipientTitle = data.recipient === 'HOD' ? 'The Head of Department' : data.recipient === 'Dean' ? 'The Dean of Faculty' : data.recipient === 'Registrar' ? 'The University Registrar' : 'A Specific Lecturer';
                 const salutation = data.recipient === 'Lecturer' ? 'Dear Sir/Madam,' : `Dear ${data.recipient},`;

                 return `${currentDate}

${recipientTitle}
[Department/Faculty Name]
[University Name]

${salutation}

SUBJECT: FORMAL REQUEST FOR ${purposeTitle} - ${data.matricNumber}

I am writing to formally request the ${data.purpose.replace(/_/g, ' ')} concerning my academic records/status.

My details are:
Name: ${data.name}
Matriculation Number: ${data.matricNumber}

JUSTIFICATION / DETAILS
${data.details}

I sincerely apologize for any inconvenience this may cause and kindly request your favorable consideration and prompt action on this matter.

Thank you.

Yours faithfully,
${data.name}
${data.matricNumber}`;
            } else if (docType === "coverLetter") {
                 return `[Date]

[Hiring Manager Name]
[Company Name]
[Company Address]

Dear [Hiring Manager],

I am writing to express my enthusiastic interest in the ${data.jobTitle} position at ${data.companyName}. With a background in ${data.experience.split('\n')[0].substring(0, 50)}..., I possess the necessary skills to excel.

I look forward to discussing how my experience can benefit your team.

Sincerely,
${data.name}`;
            } else if (docType === "resignation") {
                 return `[Date]

[Manager Name]
[Company Name]

Dear [Manager Name],

Please accept this letter as formal notification that I am resigning from my position as ${data.position}, effective ${data.lastDay}. My reason for leaving is ${data.reason}.

Thank you for the opportunity to work here.

Sincerely,
${data.name}`;
            }
            return "AI could not generate document. Please provide more detailed input.";
        }

        function validateForm(docType) { 
          if (docType === "resume") {
                return document.getElementById('fullName').value && document.getElementById('email').value && document.getElementById('experience').value && document.getElementById('education').value && document.getElementById('skills').value;
            } else if (docType === "coverLetter") {
                 return document.getElementById('cl_fullName').value && document.getElementById('cl_jobTitle').value && document.getElementById('cl_companyName').value && document.getElementById('cl_experience').value;
            } else if (docType === "resignation") {
                 return document.getElementById('rl_fullName').value && document.getElementById('rl_position').value && document.getElementById('rl_lastDay').value;
            } else if (docType === "academic") {
                 return document.getElementById('ac_fullName').value && document.getElementById('ac_matricNumber').value && document.getElementById('ac_purpose').value && document.getElementById('ac_details').value;
            }
          return true; 
        }

        // Mock PDF Download (Only works if paid)
        function downloadPDF() { 
            if (!isPaid) {
                 showModal("❌ Please complete payment to download the final document.", true);
                 return;
            }
            showModal("📄 Generating PDF...");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const docTypeDisplay = document.getElementById('documentType').options[document.getElementById('documentType').selectedIndex].text;
            const filename = `${docTypeDisplay.replace(/[^a-zA-Z0-9]/g, '_')}_Generated.pdf`;

            doc.setFontSize(12);
            const lines = doc.splitTextToSize(generatedDocumentText, 180);
            doc.text(lines, 10, 10);
            doc.save(filename);

            showModal("✅ PDF downloaded successfully!");
        }

        // Print Document (FIXED: Uses window.print() and relies on @media print CSS)
        function printDocument() { 
            if (!isPaid) {
                 showModal("❌ Please complete payment to print the final document.", true);
                 return;
            }
            // The magic is in the CSS @media print block
            window.print(); 
        }

        // Email Document (FIXED: Uses mailto: protocol)
        function emailDocument() { 
            if (!isPaid) {
                 showModal("❌ Please complete payment to email the final document.", true);
                 return;
            }
            
            const emailData = collectFormData(currentDocumentType);
            const subject = `Your ${document.getElementById('documentType').options[document.getElementById('documentType').selectedIndex].text} from Jobletters.xyz`;
            const body = `Dear ${emailData.name || 'User'},\n\nAttached is your final AI-generated document:\n\n---\n${generatedDocumentText}\n---`;
            
            // Try to use the email from the form data, defaulting to a placeholder
            const userEmail = emailData.email || document.getElementById('email')?.value || '';
            
            if (!userEmail) {
                showModal("⚠️ Please enter your email in the form before attempting to email.", true);
                return;
            }
            
            window.location.href = `mailto:${userEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            showModal("📧 Opening your email client..."); 
        }

        // --- Utility Functions ---
        function showModal(message, isError = false) {
          const modal = document.createElement('div');
          modal.className = 'modal' + (isError ? ' error' : '');
          modal.textContent = message;
          document.body.appendChild(modal);
          modal.offsetWidth; 
          modal.classList.add('show');
          setTimeout(() => {
              modal.classList.remove('show');
              setTimeout(() => modal.remove(), 500);
          }, 4000);
        }
        
        // Admin access cheat code
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && (e.ctrlKey || e.metaKey) && e.key === 'A') {
                e.preventDefault();
                const password = prompt("Admin Secret Code:");
                if (password === 'jobadmin2025') { 
                    localStorage.setItem(STORAGE_PREFIX + 'admin_access', 'granted');
                    document.getElementById('adminLink').classList.remove('hidden');
                    showModal("🔑 Admin access granted! Link is in the top menu.");
                } else if (password !== null) {
                    showModal("❌ Invalid Secret Code.", true);
                }
            }
        });
    </script>
</body>
</html>
