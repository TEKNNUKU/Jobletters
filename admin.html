<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Jobletters.xyz</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0047ab">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
      // NEW FIRESTORE IMPORTS (Including getDocs and query)
      import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"; 
      
      const firebaseConfig = {
        apiKey: "AIzaSyDLGrQQd2SEppdZooI7VWV7I7h4l_QAdZs",
        authDomain: "jobletters-3c5ea.firebaseapp.com",
        projectId: "jobletters-3c5ea",
        storageBucket: "jobletters-3c5ea.firebasestorage.app",
        messagingSenderId: "473489426093",
        appId: "1:473489426093:web:fae4d21f759d14837aa824",
        measurementId: "G-TR8CQ7EP54"
      };
      
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      window.db = getFirestore(app); 
      
      // Expose the Firestore functions globally
      window.firebase = { doc, getDoc, setDoc, updateDoc, collection, getDocs, query, orderBy, serverTimestamp };
    </script>

    <style>
        /* CSS from previous admin.html version */
        :root { --primary: #0047ab; --secondary: #667eea; --accent: #ffd700; --bg-color: #f7f9fc; --text-color: #333; --card-bg: white; --gradient-main: linear-gradient(135deg, var(--primary) 0%, #0066cc 100%); }
        * { box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        header { background: var(--gradient-main); color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 28px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-box { background: #e6f0ff; padding: 20px; border-radius: 8px; text-align: center; border-left: 5px solid var(--primary); }
        .stat-box h3 { margin: 0 0 5px 0; font-size: 16px; color: var(--primary); }
        .stat-box p { font-size: 28px; font-weight: 700; color: var(--text-color); margin: 0; }
        
        /* Settings Form */
        form label { display: block; font-weight: 600; margin-top: 15px; }
        form input { font-family: 'Montserrat', sans-serif; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; padding: 10px 12px; margin-top: 5px; width: 100%; }
        .button { background: #28a745; border: none; color: white; font-weight: 700; padding: 12px 25px; border-radius: 4px; cursor: pointer; margin-top: 20px; transition: background-color 0.3s ease; }
        .button:hover { background: #1e7e34; }

        /* User Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        table th, table td { border: 1px solid #eee; padding: 12px; text-align: left; }
        table th { background-color: #f1f1f1; color: var(--text-color); font-weight: 700; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        tbody tr:hover { background-color: #e6f0ff; }
        .spinner { border: 4px solid rgba(0, 71, 171, 0.3); border-top: 4px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal for alerts */
        .modal { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 100%); background: #333; color: white; padding: 15px 25px; border-radius: 8px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.5s ease-out; opacity: 0; }
        .modal.show { transform: translate(-50%, 0); opacity: 1; }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-lock"></i> Jobletters.xyz Admin Dashboard</h1>
        <p>Manage Settings, View Metrics, and Monitor User Activity</p>
    </header>

    <main class="container">
        
        <div class="card">
            <h2><i class="fas fa-chart-line"></i> Key Metrics</h2>
            <div id="metrics-loading" class="spinner"></div>
            <div id="metrics-error" style="color: red; text-align: center; display: none;">Error loading metrics.</div>
            <div class="stats-grid" id="metrics-display" style="display: none;">
                <div class="stat-box">
                    <h3>Total Income</h3>
                    <p id="totalIncome">₦0</p>
                </div>
                <div class="stat-box">
                    <h3>AI Generations</h3>
                    <p id="totalGenerations">0</p>
                </div>
                <div class="stat-box">
                    <h3>Final Downloads</h3>
                    <p id="totalDownloads">0</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-cog"></i> Application Settings</h2>
            <form id="settingsForm">
                <label for="apiKey">Mock AI API Key (ChatGPT/OpenAI)</label>
                <input type="text" id="apiKey" required />
                <p style="font-size: 0.85em; color: #555;">This key is used by the frontend to mock an API call for generation.</p>

                <label for="documentPrice">Document Price (Naira)</label>
                <input type="number" id="documentPrice" required min="1" />
                <p style="font-size: 0.85em; color: #555;">Changing this will instantly update the price on all user tabs.</p>

                <button type="submit" class="button"><i class="fas fa-save"></i> Save Settings</button>
            </form>
        </div>

        <div class="card">
            <h2><i class="fas fa-users"></i> Recent User Generations</h2>
            <div id="users-loading" class="spinner"></div>
            <table id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Document Type</th>
                        <th>Generations</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    </tbody>
            </table>
            <button class="button" onclick="loadUserDataTable()"><i class="fas fa-redo"></i> Refresh User Data</button>
        </div>
    </main>
    
    <script>
        const STORAGE_PREFIX = 'jobletters_';
        const MOCK_ADMIN_API_KEY = "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";
        
        // Ensure Firebase is loaded before proceeding
        window.addEventListener('load', () => {
             // Delay to ensure global variables are set by the module script
             setTimeout(() => {
                 if (typeof window.db !== 'undefined' && typeof window.firebase !== 'undefined') {
                    checkAccess();
                    loadAllData();
                 } else {
                    document.body.innerHTML = '<h1>Firebase Initialization Error</h1><p>Please check your console for errors and ensure Firebase SDK is correctly loaded.</p>';
                 }
             }, 500); 
        });

        function checkAccess() {
            if (localStorage.getItem(STORAGE_PREFIX + 'admin_access') !== 'granted') {
                alert("Access Denied. Please log in from the main page.");
                window.location.href = '/index.html';
            }
        }
        
        function loadAllData() {
            loadMetrics();
            loadSettings();
            loadUserDataTable();
        }

        // --- Metric Management (FIRESTORE READ) ---
        async function loadMetrics() {
            const { doc, getDoc } = window.firebase;
            const configRef = doc(window.db, "settings", "config");
            
            document.getElementById('metrics-loading').style.display = 'block';
            document.getElementById('metrics-display').style.display = 'none';
            document.getElementById('metrics-error').style.display = 'none';

            try {
                const docSnap = await getDoc(configRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('totalIncome').textContent = `₦${(data.totalIncome || 0).toLocaleString()}`;
                    document.getElementById('totalGenerations').textContent = (data.totalGenerations || 0).toLocaleString();
                    document.getElementById('totalDownloads').textContent = (data.totalDownloads || 0).toLocaleString();
                } else {
                    document.getElementById('totalIncome').textContent = '₦0';
                    document.getElementById('totalGenerations').textContent = '0';
                    document.getElementById('totalDownloads').textContent = '0';
                }
                document.getElementById('metrics-display').style.display = 'grid';
            } catch (error) {
                console.error("Error loading metrics:", error);
                document.getElementById('metrics-error').style.display = 'block';
            } finally {
                document.getElementById('metrics-loading').style.display = 'none';
            }
        }

        // --- Settings Management (FIRESTORE READ & WRITE) ---
        async function loadSettings() {
            const { doc, getDoc } = window.firebase;
            const configRef = doc(window.db, "settings", "config");
            
            try {
                const docSnap = await getDoc(configRef);
                const data = docSnap.exists() ? docSnap.data() : {};
                
                const apiKey = data.apiKey || MOCK_ADMIN_API_KEY;
                // Clean the price string from '₦' and ensure it's a number for the input field
                const price = parseInt((data.documentPrice || '₦500').replace('₦', '') || '500');

                document.getElementById('apiKey').value = apiKey;
                document.getElementById('documentPrice').value = price;
            } catch (error) {
                console.error("Error loading settings:", error);
                showModal("❌ Could not load settings from database.");
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', saveSettings);
        
        async function saveSettings(event) {
            event.preventDefault();
            
            const { doc, updateDoc, serverTimestamp } = window.firebase;
            const configRef = doc(window.db, "settings", "config");
            
            const apiKey = document.getElementById('apiKey').value.trim();
            const priceInput = document.getElementById('documentPrice').value;
            const price = `₦${parseInt(priceInput)}`;

            if (!apiKey || isNaN(parseInt(priceInput))) {
                showModal("Error: Please provide a mock API key and a valid price (number).");
                return;
            }

            try {
                await updateDoc(configRef, {
                    apiKey: apiKey,
                    documentPrice: price,
                    lastUpdated: serverTimestamp()
                });
                
                // IMPORTANT: Update localStorage to trigger the 'storage' event on all user tabs
                localStorage.setItem(STORAGE_PREFIX + 'api_key', apiKey);
                localStorage.setItem(STORAGE_PREFIX + 'price', price);
                
                showModal(`✅ Settings Saved! Price set to: ${price}`);
                loadSettings(); // Refresh form display
            } catch (error) {
                console.error("Error saving settings:", error);
                showModal("❌ Error saving settings to Firestore.");
            }
        }

        // --- User Data Table (FIRESTORE READ) ---
        async function loadUserDataTable() {
            const { collection, getDocs, query, orderBy } = window.firebase;
            const tableBody = document.getElementById('usersTableBody');
            
            tableBody.innerHTML = ''; // Clear existing data
            document.getElementById('users-loading').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';

            try {
                // Query the 'users' collection, ordered by last generated time
                const usersCol = collection(window.db, "users");
                const q = query(usersCol, orderBy("lastGenerated", "desc"));
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    const lastActivity = user.lastGenerated ? new Date(user.lastGenerated.toDate()).toLocaleString() : 'N/A';
                    
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = user.name || 'N/A';
                    row.insertCell(1).textContent = user.email || 'N/A';
                    row.insertCell(2).textContent = user.documentType || 'N/A';
                    row.insertCell(3).textContent = user.generations || 1;
                    row.insertCell(4).textContent = lastActivity;
                });

                document.getElementById('usersTable').style.display = 'table';
            } catch (error) {
                console.error("Error loading user data:", error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Failed to load user data from Firestore.</td></tr>';
                document.getElementById('usersTable').style.display = 'table'; // Show table with error message
            } finally {
                document.getElementById('users-loading').style.display = 'none';
            }
        }

        function showModal(message) {
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.textContent = message;
          document.body.appendChild(modal);
          modal.offsetWidth; 
          modal.classList.add('show');
          setTimeout(() => {
              modal.classList.remove('show');
              setTimeout(() => modal.remove(), 500);
          }, 4000);
        }
    </script>
</body>
</html>
