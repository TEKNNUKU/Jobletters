<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jobletters.xyz - Admin Panel</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0047ab">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
      // Import ALL necessary Firestore functions, including getDocs, query, and orderBy
      import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        collection, 
        serverTimestamp, 
        getDocs, // <-- New requirement for admin panel
        query, // <-- New requirement for admin panel
        orderBy // <-- New requirement for admin panel
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"; 
      
      const firebaseConfig = {
        apiKey: "AIzaSyDLGrQQd2SEppdZooI7VWV7I7h4l_QAdZs",
        authDomain: "jobletters-3c5ea.firebaseapp.com",
        projectId: "jobletters-3c5ea",
        storageBucket: "jobletters-3c5ea.firebasestorage.app",
        messagingSenderId: "473489426093",
        appId: "1:473489426093:web:fae4d21f759d14837aa824",
        measurementId: "G-TR8CQ7EP54"
      };
      
      // Initialize Firebase and make Firestore available globally
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      window.db = getFirestore(app); 
      
      // Expose the Firestore functions globally so the <script> block can use them
      window.firebase = { 
          doc, getDoc, setDoc, collection, 
          serverTimestamp, getDocs, query, orderBy 
      };
    </script>

    <style>
        /* Base and Admin Panel Styles */
        :root { --primary: #0047ab; --secondary: #667eea; --accent: #ffd700; --bg-color: #f0f2f5; --text-color: #333; --card-bg: white; --success: #28a745; --danger: #dc3545; }
        * { box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
        header { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; }
        .logo i { margin-right: 10px; color: var(--accent); }
        .container { max-width: 1000px; margin: 30px auto; padding: 20px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-top: 0; font-size: 28px; }
        h2 i { color: var(--accent); margin-right: 10px; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .metric-card { flex: 1 1 200px; background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-card h3 { margin: 0 0 10px 0; font-size: 16px; color: #777; }
        .metric-card p { margin: 0; font-size: 32px; font-weight: 700; color: var(--text-color); }
        .metric-card.income { border-color: var(--success); }
        .metric-card.generations { border-color: var(--secondary); }
        .metric-card.downloads { border-color: var(--accent); }

        /* Settings and User Table */
        .settings-form, .user-table-container { margin-top: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .settings-form h3, .user-table-container h3 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        
        form label { display: block; font-weight: 600; margin-top: 15px; }
        form input { font-family: 'Montserrat', sans-serif; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; padding: 12px; margin-top: 5px; width: 100%; resize: vertical; }
        
        .btn-save { background: var(--primary); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; margin-top: 20px; width: auto; }
        .btn-save:hover:not(:disabled) { background: #003380; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }

        /* User Table */
        .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .user-table th, .user-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .user-table th { background-color: var(--primary); color: white; font-weight: 700; }
        .user-table tr:nth-child(even) { background-color: #f7f7f7; }
        .user-table tr:hover { background-color: #e6f0ff; }
        .loading-text { text-align: center; color: #777; padding: 20px; }

        /* Login Screen */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 400px; }
        .login-box h3 { color: var(--primary); margin-bottom: 20px; font-size: 24px; }
        #loginPassword { margin-bottom: 20px; }
        .btn-login { background: var(--danger); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; width: 100%; }
        .btn-login:hover { background: #a31a29; }
        .hidden { display: none !important; }

        /* Modal */
        .modal { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 100%); background: var(--success); color: white; padding: 15px 25px; border-radius: 8px; z-index: 3000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.5s ease-out, opacity 0.5s; opacity: 0; }
        .modal.error { background: var(--danger); }
        .modal.show { transform: translate(-50%, 0); opacity: 1; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><i class="fas fa-lock"></i> Admin Panel</div>
        <a href="index.html" style="color: white; text-decoration: none;"><i class="fas fa-home"></i> Go to App</a>
    </header>

    <main class="container hidden" id="adminContent">
        <h2>üìä Jobletters.xyz Dashboard</h2>

        <div class="dashboard-grid">
            <div class="metric-card income">
                <h3>Total Income (Simulated)</h3>
                <p id="totalIncome">‚Ç¶0</p>
            </div>
            <div class="metric-card generations">
                <h3>Documents Generated</h3>
                <p id="totalGenerations">0</p>
            </div>
            <div class="metric-card downloads">
                <h3>Documents Unlocked/Downloaded</h3>
                <p id="totalDownloads">0</p>
            </div>
        </div>

        <div class="settings-form">
            <h3>‚öôÔ∏è System Settings</h3>
            <form id="settingsForm">
                <p style="color: var(--danger); font-weight: 600;">‚ö†Ô∏è **CRITICAL SECURITY NOTE:** Never commit the **REAL** AI API Key to a public repository. This panel only updates the Firestore database, which the app reads.</p>

                <label for="apiKey">AI API Key (Must be revoked if exposed)</label>
                <input type="password" id="apiKey" placeholder="sk-proj-**********************************" required />
                
                <label for="documentPrice">Document Price (e.g., ‚Ç¶500 or $5)</label>
                <input type="text" id="documentPrice" placeholder="‚Ç¶500" required />

                <button type="submit" class="btn-save" id="saveSettingsBtn">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </form>
        </div>

        <div class="user-table-container">
            <h3>üë• User Generation Records</h3>
            <div id="userTableData">
                <p class="loading-text"><i class="fas fa-spinner fa-spin"></i> Loading user data...</p>
                <table class="user-table hidden" id="userTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Document Type</th>
                            <th>Generations</th>
                            <th>Last Activity</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h3>üîí Admin Login</h3>
            <p>Enter the secret code to access the dashboard.</p>
            <input type="password" id="loginPassword" placeholder="Secret Code" required />
            <button class="btn-login" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Access Dashboard
            </button>
        </div>
    </div>

    <script>
        const STORAGE_PREFIX = 'jobletters_';
        const ADMIN_SECRET_CODE = 'jobadmin2025'; // The hardcoded key for local access

        // --- Utility Functions ---
        function showModal(message, isError = false) {
            const modal = document.createElement('div');
            modal.className = 'modal' + (isError ? ' error' : '');
            modal.textContent = message;
            document.body.appendChild(modal);
            modal.offsetWidth; // Trigger reflow
            modal.classList.add('show');
            setTimeout(() => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 500);
            }, 4000);
        }

        // --- Admin Login Logic ---
        function handleLogin() {
            const password = document.getElementById('loginPassword').value;
            if (password === ADMIN_SECRET_CODE) {
                localStorage.setItem(STORAGE_PREFIX + 'admin_access', 'granted');
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                initAdminDashboard();
                showModal("üîë Welcome, Admin!");
            } else {
                showModal("‚ùå Invalid Secret Code.", true);
            }
        }

        function checkLoginStatus() {
            if (localStorage.getItem(STORAGE_PREFIX + 'admin_access') === 'granted') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                initAdminDashboard();
            }
        }

        // --- Firestore Data Handlers ---

        /**
         * Fetches and displays the main dashboard metrics and current settings.
         */
        async function fetchDashboardMetrics() {
            if (!window.db || !window.firebase) {
                console.error("Firebase not initialized.");
                return;
            }

            const { doc, getDoc } = window.firebase;
            const configRef = doc(window.db, "settings", "config");

            try {
                const docSnap = await getDoc(configRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Display Metrics
                    document.getElementById('totalIncome').textContent = `‚Ç¶${data.totalIncome ? data.totalIncome.toLocaleString() : '0'}`;
                    document.getElementById('totalGenerations').textContent = data.totalGenerations ? data.totalGenerations.toLocaleString() : '0';
                    document.getElementById('totalDownloads').textContent = data.totalDownloads ? data.totalDownloads.toLocaleString() : '0';

                    // Load Settings for editing
                    document.getElementById('apiKey').value = data.apiKey || '';
                    document.getElementById('documentPrice').value = data.documentPrice || '‚Ç¶500';

                    // Update localStorage for index.html sync (Critical)
                    localStorage.setItem(STORAGE_PREFIX + 'api_key', data.apiKey || '');
                    localStorage.setItem(STORAGE_PREFIX + 'price', data.documentPrice || '‚Ç¶500');

                } else {
                    showModal("‚ö†Ô∏è Config document not found. Please save initial settings.", true);
                }
            } catch (error) {
                console.error("Error fetching dashboard metrics:", error);
                showModal("‚ùå Error fetching data from Firestore.", true);
            }
        }

        /**
         * Fetches and populates the user generation table.
         */
        async function fetchUserTable() {
            if (!window.db || !window.firebase) return;

            const { collection, getDocs, query, orderBy } = window.firebase;
            const usersCol = collection(window.db, "users");
            const q = query(usersCol, orderBy("lastGenerated", "desc"));
            const tableBody = document.getElementById('userTableBody');
            
            tableBody.innerHTML = ''; // Clear existing data
            document.querySelector('.loading-text').classList.remove('hidden');
            document.getElementById('userTable').classList.add('hidden');

            try {
                const querySnapshot = await getDocs(q);
                let rowsHtml = '';
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const lastActivity = data.lastGenerated ? new Date(data.lastGenerated.toDate()).toLocaleString() : 'N/A';
                    
                    rowsHtml += `
                        <tr>
                            <td>${data.name || 'N/A'}</td>
                            <td>${data.email || 'N/A'}</td>
                            <td>${data.documentType || 'N/A'}</td>
                            <td>${data.generations || 0}</td>
                            <td>${lastActivity}</td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = rowsHtml;
                document.querySelector('.loading-text').classList.add('hidden');
                document.getElementById('userTable').classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching user table:", error);
                document.querySelector('.loading-text').textContent = "Error loading user data.";
            }
        }

        /**
         * Saves the AI API Key and Document Price to Firestore.
         */
        async function saveSettings(event) {
            event.preventDefault();
            const saveBtn = document.getElementById('saveSettingsBtn');
            saveBtn.disabled = true;

            if (!window.db || !window.firebase) {
                showModal("‚ùå Database connection failed.", true);
                saveBtn.disabled = false;
                return;
            }

            const apiKey = document.getElementById('apiKey').value;
            const documentPrice = document.getElementById('documentPrice').value;
            
            if (!apiKey || !documentPrice) {
                 showModal("‚ö†Ô∏è Both API Key and Price are required.", true);
                 saveBtn.disabled = false;
                 return;
            }

            const { doc, setDoc, serverTimestamp } = window.firebase;
            const configRef = doc(window.db, "settings", "config");

            try {
                await setDoc(configRef, {
                    apiKey: apiKey,
                    documentPrice: documentPrice,
                    lastUpdated: serverTimestamp()
                }, { merge: true }); // Use merge to keep totalIncome, etc.

                // Update localStorage for index.html sync
                localStorage.setItem(STORAGE_PREFIX + 'api_key', apiKey);
                localStorage.setItem(STORAGE_PREFIX + 'price', documentPrice);

                showModal("‚úÖ Settings saved successfully! App key/price updated.");
                fetchDashboardMetrics(); // Refresh to ensure metrics are current

            } catch (error) {
                console.error("Error saving settings:", error);
                showModal("‚ùå Error saving settings to Firestore.", true);
            } finally {
                saveBtn.disabled = false;
            }
        }

        // --- Initialization ---
        function initAdminDashboard() {
            // Attach event listener for saving settings
            document.getElementById('settingsForm').addEventListener('submit', saveSettings);
            
            // Initial data load
            fetchDashboardMetrics();
            fetchUserTable();
        }

        // Check login status on page load
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

    </script>
</body>
</html>
